<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Billedvæg</title>
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
        font-size: 14pt;
        font-family: Arial, Helvetica, sans-serif;
      }

      input,
      select {
        font-size: inherit;
        font-family: Arial, Helvetica, sans-serif;
      }

      code {
        color: rgb(216, 39, 39);
        background-color: rgb(228, 227, 227);
      }

      #wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 80vw;
        margin: auto;
      }

      #main {
        flex: 1;
        margin-top: 5%;
      }

      fieldset {
        display: flex;
      }

      fieldset img {
        order: 1;
        margin-right: 1rem;
      }

      fieldset div {
        flex: 1;
        order: 2;
      }

      .person-inputs div {
        display: grid;
        grid-template-columns: 16ch auto;
      }

      input[type="submit"] {
        margin-top: 2rem;
      }
    </style>
  </head>
  <body>
    <div id="wrapper">
      <div id="main">
        <h1>Billedvæg</h1>
        <p>Her på siden kan du vælge et antal billeder og generere en billedvæg.</p>

        <p>
          Vælg de billeder, du vil have med i filen, og tryk på knappen nederst for at få
          din billedvægs-fil
        </p>

        <p>
          Systemet prøver at "gætte" på folks oplysninger, hvis filerne er navngivet efter
          formen <code>NAVN_STILLING_SUPPLERENDE.jpg</code>, hvor <code>STILLING</code> er
          en af følgende:
        </p>

        <ul>
          <li><code>LO</code> = ledende overlæge</li>
          <li><code>OL-Pro</code> = Overlæge, professor</li>
          <li><code>UAO</code> = Uddannelsesansvarlig overlæge</li>
          <li><code>OL</code> = Overlæge</li>
          <li><code>AL</code> = Afdelingslæge</li>
          <li><code>HU</code> = HU Neurologi</li>
          <li><code>I</code> = Introduktionslæge</li>
          <li><code>Ps</code> = HU Psyk</li>
        </ul>

        <p>
          og <code>SUPPLERENDE</code> for yngre læger er deres vejleders navn/initialer og
          for speciallæger er subspeciale. Ønskes andet end vejlederen for yngre læger,
          kan der vinges af i <code>special</code>-checkboxen, så der ikke tilføjes
          teksten "Vejleder: " forrest i feltet, når PDF'en laves.
        </p>

        <p>
          Hvis filerne er navngivet anderledes, kan det rettes til i formularen, der
          dukker op.
        </p>

        <p>
          Man skal være opmærksom på "specielle" tegn (fx æ, ø, å, ü, ä mv.), som er
          blevet udledt af filnavnet - de kan evt. give vanskeligheder i den genererede
          PDF, selvom de umiddelbart vises korrekt i formularen. Her kan det hjælp at
          skrive det manuelt i formularen.
        </p>

        <form action="/" method="POST" enctype="multipart/form-data">
          <input
            type="file"
            name="file"
            multiple="multiple"
            accept="image/*"
            onchange="load(this)"
          />
          <br />
          <input type="checkbox" name="special" id="special" />
          <label for="special">Speciallæger?</label>
          <div id="images"></div>
          <input id="submit" type="submit" value="Lav billedvæg" />
        </form>
      </div>
      <footer>
        <p>
          Lavet af læge Sigurd Morsby Larsen, uddannelseskoordinerende yngre læge,
          Neurologi, Aarhus Universitetshospital
        </p>
      </footer>
    </div>
  </body>
  <script>
    // tag = element to create
    // html = tag's html contents
    // tags = [["attribute", "value"], ...]
    function createEl(tag, html = null, tags = []) {
      const el = document.createElement(tag);
      el.innerHTML = html;
      tags.forEach((tag) => {
        if (
          tag[0] === undefined ||
          tag[0] === null ||
          tag[1] === undefined ||
          tag[1] === null
        ) {
          return;
        }

        el.setAttribute(tag[0], tag[1]);
      });
      return el;
    }

    function createMetadata(string) {
      const parts = string.split("_");

      if (parts.length != 3) {
        return { name: "", position: "", suppl: "" };
      }

      return {
        name: parts[0],
        position: parts[1],
        suppl: parts[2].replaceAll("-", "/").replace(/\.[^/.]+$/, ""), // trims extension,
      };
    }

    function createInput(value, name, label) {
      const div = createEl("div");
      const labelEl = createEl("label", label + ": ");
      labelEl.setAttribute("for", name);
      const input = createEl("input", null, [
        ["type", "text"],
        ["value", value],
        ["name", name],
        ["id", name],
      ]);
      div.appendChild(labelEl);
      div.appendChild(input);
      return div;
    }

    function createPositionsDropdown(value, name) {
      const div = createEl("div");
      const labelEl = createEl("label", "Stilling: ");
      labelEl.setAttribute("for", name);
      const input = createEl("select", null, [
        ["name", name],
        ["id", name],
      ]);
      input.appendChild(
        createEl("option", "Ledende overlæge", [
          ["value", "LO"],
          ["selected", "LO" === value ? "true" : null],
        ])
      );
      input.appendChild(
        createEl("option", "Overlæge, professor", [
          ["value", "OL-Pro"],
          ["selected", "OL-Pro" === value ? "true" : null],
        ])
      );
      input.appendChild(
        createEl("option", "Uddannelsesansvarlig", [
          ["value", "UAO"],
          ["selected", "UAO" === value ? "true" : null],
        ])
      );
      input.appendChild(
        createEl("option", "Overlæge", [
          ["value", "OL"],
          ["selected", "OL" === value ? "true" : null],
        ])
      );
      input.appendChild(
        createEl("option", "Afdelingslæge", [
          ["value", "AL"],
          ["selected", "AL" === value ? "true" : null],
        ])
      );
      input.appendChild(
        createEl("option", "HU Neurologi", [
          ["value", "HU"],
          ["selected", "HU" === value ? "true" : null],
        ])
      );
      input.appendChild(
        createEl("option", "Introduktionslæge", [
          ["value", "I"],
          ["selected", "I" === value ? "true" : null],
        ])
      );
      input.appendChild(
        createEl("option", "HU Psyk", [
          ["value", "Ps"],
          ["selected", "Ps" === value ? "true" : null],
        ])
      );

      div.appendChild(labelEl);
      div.appendChild(input);
      return div;
    }

    function load(el) {
      document.querySelector("#images").innerHTML = null;

      const files = el.files;
      const rows = createEl("div");
      for (let n = 0; n < files.length; n++) {
        const row = document.createElement("fieldset");
        const person = createMetadata(files[n].name);

        row.appendChild(createEl("legend", files[n].name));

        const reader = new FileReader();
        reader.onload = function () {
          row.appendChild(
            createEl("img", null, [
              ["src", reader.result],
              ["width", 100],
            ])
          );
        };
        reader.readAsDataURL(files[n]);

        const div = createEl("div", null, [["class", "person-inputs"]]);
        div.appendChild(createInput(person.name, files[n].name + "-name", "Navn"));
        div.appendChild(
          createPositionsDropdown(person.position, files[n].name + "-position")
        );
        div.appendChild(
          createInput(person.suppl, files[n].name + "-suppl", "Supplerende")
        );
        row.appendChild(div);

        rows.appendChild(row);
      }

      document.querySelector("#images").appendChild(rows);
    }
  </script>
</html>
